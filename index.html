<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprehensive Notes App</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        h1, h2 {
            color: #2c3e50;
        }
        input[type="text"], input[type="email"], textarea {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #2980b9;
        }
        .note {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 10px;
        }
        #projectsList, #notesList {
            margin-top: 20px;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <h1>Comprehensive Notes App</h1>
    
    <div id="authSection">
        <h2>Authentication</h2>
        <div id="signInButtons">
            <button id="googleSignIn">Sign in with Google</button>
            <button id="emailSignIn">Sign in with Email</button>
        </div>
        <div id="emailSignInForm" class="hidden">
            <input type="email" id="emailInput" placeholder="Enter your email">
            <button id="sendEmailLink">Send Sign-In Link</button>
        </div>
        <button id="signOut" class="hidden">Sign Out</button>
        <p id="userStatus"></p>
    </div>

    <div id="appContent" class="hidden">
        <h2>Projects</h2>
        <input type="text" id="projectName" placeholder="New Project Name">
        <button id="addProject">Add Project</button>
        <div id="projectsList"></div>

        <h2>Notes</h2>
        <select id="projectSelect"></select>
        <input type="text" id="noteTitle" placeholder="Note Title">
        <textarea id="noteContent" placeholder="Note Content"></textarea>
        <button id="addNote">Add Note</button>
        <div id="notesList"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, sendSignInLinkToEmail, isSignInWithEmailLink, signInWithEmailLink, signOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, getDoc, updateDoc, deleteDoc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD84fEmaDJC0m3ouTL1Di-v564bUE3RGkM",
            authDomain: "notesapp30.firebaseapp.com",
            projectId: "notesapp30",
            storageBucket: "notesapp30.appspot.com",
            messagingSenderId: "414284620791",
            appId: "1:414284620791:web:7a1f957af7e2a45421c4f2"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // DOM Elements
        const googleSignInBtn = document.getElementById('googleSignIn');
        const emailSignInBtn = document.getElementById('emailSignIn');
        const emailSignInForm = document.getElementById('emailSignInForm');
        const emailInput = document.getElementById('emailInput');
        const sendEmailLinkBtn = document.getElementById('sendEmailLink');
        const signOutBtn = document.getElementById('signOut');
        const userStatus = document.getElementById('userStatus');
        const appContent = document.getElementById('appContent');
        const projectNameInput = document.getElementById('projectName');
        const addProjectBtn = document.getElementById('addProject');
        const projectsList = document.getElementById('projectsList');
        const projectSelect = document.getElementById('projectSelect');
        const noteTitleInput = document.getElementById('noteTitle');
        const noteContentInput = document.getElementById('noteContent');
        const addNoteBtn = document.getElementById('addNote');
        const notesList = document.getElementById('notesList');

        // Authentication State Observer
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userStatus.textContent = `Signed in as ${user.displayName || 'User'} (${user.email})`;
                document.getElementById('signInButtons').classList.add('hidden');
                signOutBtn.classList.remove('hidden');
                appContent.classList.remove('hidden');
                loadProjects();
            } else {
                userStatus.textContent = 'Not signed in';
                document.getElementById('signInButtons').classList.remove('hidden');
                signOutBtn.classList.add('hidden');
                appContent.classList.add('hidden');
            }
        });

        // Google Sign-In
        googleSignInBtn.addEventListener('click', () => {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider).catch(console.error);
        });

        // Email Link Authentication
        emailSignInBtn.addEventListener('click', () => {
            emailSignInForm.classList.toggle('hidden');
        });

        sendEmailLinkBtn.addEventListener('click', () => {
            const email = emailInput.value;
            const actionCodeSettings = {
                url: window.location.href,
                handleCodeInApp: true
            };

            sendSignInLinkToEmail(auth, email, actionCodeSettings)
                .then(() => {
                    window.localStorage.setItem('emailForSignIn', email);
                    alert('Sign-in link sent to your email!');
                })
                .catch(console.error);
        });

        if (isSignInWithEmailLink(auth, window.location.href)) {
            let email = window.localStorage.getItem('emailForSignIn');
            if (!email) {
                email = window.prompt('Please provide your email for confirmation');
            }
            signInWithEmailLink(auth, email, window.location.href)
                .then(() => {
                    window.localStorage.removeItem('emailForSignIn');
                })
                .catch(console.error);
        }

        // Sign Out
        signOutBtn.addEventListener('click', () => {
            signOut(auth).catch(console.error);
        });

        // Add Project
        addProjectBtn.addEventListener('click', async () => {
            const user = auth.currentUser;
            if (user && projectNameInput.value) {
                try {
                    await addDoc(collection(db, `users/${user.uid}/projects`), {
                        name: projectNameInput.value,
                        timestamp: serverTimestamp()
                    });
                    projectNameInput.value = '';
                    loadProjects();
                } catch (error) {
                    console.error("Error adding project:", error);
                }
            }
        });

        // Load Projects
        async function loadProjects() {
            const user = auth.currentUser;
            if (user) {
                try {
                    const querySnapshot = await getDocs(query(collection(db, `users/${user.uid}/projects`), orderBy('timestamp', 'desc')));
                    projectsList.innerHTML = '';
                    projectSelect.innerHTML = '';
                    querySnapshot.forEach((doc) => {
                        const project = doc.data();
                        const projectElement = document.createElement('div');
                        projectElement.innerHTML = `
                            <h3>${project.name}</h3>
                            <button onclick="editProject('${doc.id}')">Edit</button>
                            <button onclick="deleteProject('${doc.id}')">Delete</button>
                        `;
                        projectsList.appendChild(projectElement);

                        const option = document.createElement('option');
                        option.value = doc.id;
                        option.textContent = project.name;
                        projectSelect.appendChild(option);
                    });
                } catch (error) {
                    console.error("Error loading projects:", error);
                }
            }
        }

        // Add Note
        addNoteBtn.addEventListener('click', async () => {
            const user = auth.currentUser;
            const projectId = projectSelect.value;
            if (user && projectId && noteTitleInput.value && noteContentInput.value) {
                try {
                    await addDoc(collection(db, `users/${user.uid}/projects/${projectId}/notes`), {
                        title: noteTitleInput.value,
                        content: noteContentInput.value,
                        timestamp: serverTimestamp()
                    });
                    noteTitleInput.value = '';
                    noteContentInput.value = '';
                    loadNotes(projectId);
                } catch (error) {
                    console.error("Error adding note:", error);
                }
            }
        });

        // Load Notes
        async function loadNotes(projectId) {
            const user = auth.currentUser;
            if (user && projectId) {
                try {
                    const querySnapshot = await getDocs(query(collection(db, `users/${user.uid}/projects/${projectId}/notes`), orderBy('timestamp', 'desc')));
                    notesList.innerHTML = '';
                    querySnapshot.forEach((doc) => {
                        const note = doc.data();
                        const noteElement = document.createElement('div');
                        noteElement.className = 'note';
                        noteElement.innerHTML = `
                            <h3>${note.title}</h3>
                            <p>${note.content}</p>
                            <button onclick="editNote('${projectId}', '${doc.id}')">Edit</button>
                            <button onclick="deleteNote('${projectId}', '${doc.id}')">Delete</button>
                        `;
                        notesList.appendChild(noteElement);
                    });
                } catch (error) {
                    console.error("Error loading notes:", error);
                }
            }
        }

        projectSelect.addEventListener('change', (e) => loadNotes(e.target.value));

        // Edit Project
        window.editProject = async (projectId) => {
            const user = auth.currentUser;
            if (user) {
                try {
                    const docRef = doc(db, `users/${user.uid}/projects/${projectId}`);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        const project = docSnap.data();
                        const newName = prompt("Enter new project name:", project.name);
                        if (newName) {
                            await updateDoc(docRef, { name: newName });
                            loadProjects();
                        }
                    }
                } catch (error) {
                    console.error("Error editing project:", error);
                }
            }
        };

        // Delete Project
        window.deleteProject = async (projectId) => {
            const user = auth.currentUser;
            if (user && confirm('Are you sure you want to delete this project and all its notes?')) {
                try {
                    await deleteDoc(doc(db, `users/${user.uid}/projects/${projectId}`));
                    loadProjects();
                } catch (error) {
                    console.error("Error deleting project:", error);
                }
            }
        };

        // Edit Note
        window.editNote = async (projectId, noteId) => {
            const user = auth.currentUser;
            if (user) {
                try {
                    const docRef = doc(db, `users/${user.uid}/projects/${projectId}/notes/${noteId}`);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        const note = docSnap.data();
                        const newTitle = prompt("Enter new note title:", note.title);
                        const newContent = prompt("Enter new note content:", note.content);
                        if (newTitle && newContent) {
                            await updateDoc(docRef, { 
                                title: newTitle, 
                                content: newContent,
                                timestamp: serverTimestamp()
                            });
                            loadNotes(projectId);
                        }
                    }
                } catch (error) {
                    console.error("Error editing note:", error);
                }
            }
        };

        // Delete Note
        window.deleteNote = async (projectId, noteId) => {
            const user = auth.currentUser;
            if (user && confirm('Are you sure you want to delete this note?')) {
                try {
                    await deleteDoc(doc(db, `users/${user.uid}/projects/${projectId}/notes/${noteId}`));
                    loadNotes(projectId);
                } catch (error) {
                    console.error("Error deleting note:", error);
                }
            }
        };
    </script>
</body>
</html>
